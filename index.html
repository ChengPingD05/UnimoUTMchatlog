<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SECURE ARCHIVE</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ðŸŽ¨ 1. TELEGRAM THEME VARIABLES */
        :root {
            --bg: var(--tg-theme-bg-color, #000000);
            --text: var(--tg-theme-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #888888);
            --accent: var(--tg-theme-button-color, #2481cc);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier New', Courier, monospace; /* Console Font */
            margin: 0; padding: 12px; padding-bottom: 60px; font-size: 13px;
            line-height: 1.4;
        }
        /* === ðŸ§± NEW STICKY HEADER === */
        #sticky-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--bg); /* Solid background so text doesnt show through */
            border-bottom: 1px dashed var(--hint);
            padding: 12px 12px 5px 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .status-bar {
            display: flex; 
            justify-content: space-between; /* Pushes items to edges */
            align-items: center;
            margin-bottom: 8px; 
            font-size: 11px; font-weight: bold;
        }

        /* Right align specific fix */
        .status-right {
            text-align: right;
        }

        .terminal-header {
            color: var(--hint);
            font-size: 10px;
            margin-bottom: 5px;
        }

        /* === ðŸ“œ LOGS CONTAINER === */
        #logs {
            padding: 12px;
        }
        
        #loader {
            position: fixed; top: 40%; left: 0; width: 100%; text-align: center;
            color: var(--hint); font-weight: bold;
        }

        .terminal-header {
            border-bottom: 1px dashed var(--hint);
            padding-bottom: 8px; margin-bottom: 15px; color: var(--hint);
        }

        /* ðŸš€ 2. CONSOLE LAYOUT (No Bubbles, Fast Read) */
        .msg {
            margin-bottom: 12px;
            display: flex; flex-direction: column;
            border-left: 3px solid transparent; 
            padding-left: 10px;
            /* No Animation Delay -> Loads Instantly */
        }

        .meta {
            font-size: 10px; margin-bottom: 2px;
            color: var(--hint); display: flex; justify-content: space-between;
        }

        /* Role Indicators */
        .me { border-left-color: var(--accent); }     /* Blue/Green line */
        .them { border-left-color: var(--hint); }     /* Grey line */
        
        .content { word-wrap: break-word; white-space: pre-wrap; }

        .btn-ev {
            margin-top: 5px; padding: 4px 8px; font-size: 10px; 
            color: var(--accent); border: 1px solid var(--accent);
            cursor: pointer; display: inline-block; text-transform: uppercase;
            text-decoration: none;
        }
        
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding: 5px; border-radius: 4px;
            font-size: 11px; font-weight: bold;
        }

        .badge-live {
            background-color: #1a4d1a; color: #4dff4d;
            border: 1px solid #4dff4d; padding: 2px 6px;
            animation: pulse 2s infinite;
        }

        .badge-archive {
            background-color: #333; color: #aaa;
            border: 1px solid #666; padding: 2px 6px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* === ðŸš¨ NEW MESSAGE BREATHING ANIMATION === */
        @keyframes breathing-bg {
            0% { background-color: rgba(36, 129, 204, 0.0); }
            50% { background-color: rgba(36, 129, 204, 0.25); } /* Blue tint */
            100% { background-color: rgba(36, 129, 204, 0.0); }
        }

        .msg.unread {
            animation: breathing-bg 1.5s infinite ease-in-out;
            border-left: 3px solid #ff4d4d; /* Red border to indicate attention needed */
        }
        
        
    </style>
</head>
<body>

    <div id="loader">> ESTABLISHING CONNECTION...</div>
    
    <div id="terminal" style="display:none;">
        <div id="sticky-container">
            <div id="status-header" class="status-bar">
                <span style="color: var(--hint)">RIDE_ID: <span id="ride-disp" style="color: var(--text)">...</span></span>
                <div class="status-right">
                    <span id="status-badge">LOADING...</span>
                </div>
            </div>
            <div class="terminal-header">
                > UNIMOUTM_CHATLOGS_V1
            </div>
        </div>

        <div id="logs"></div>
    </div>

    <script>
        // ðŸ›‘ CONFIG
        const API_URL = 'https://zvoywylatpccjpwvrrhz.supabase.co'; 
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2b3l3eWxhdHBjY2pwd3Zycmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwOTU5NzEsImV4cCI6MjA4MjY3MTk3MX0.fSoxr1kYwJfC7NBtJpisGhMiJL7LrTCZIp269k0XoKE'; // âš ï¸ PASTE YOUR KEY HERE
        const BOT_HANDLE = 'chengtechtest_bot'; 
        const db = supabase.createClient(API_URL, API_KEY);
        const params = new URLSearchParams(window.location.search);
        const USER_HASH = params.get('user_hash');
        const TOKEN = params.get('token');
        const MY_ID = params.get('user_id');
        let nameMap = {};
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Element is on screen.
                    // Wait 2.5 seconds, then stop breathing.
                    setTimeout(() => {
                        entry.target.classList.remove('unread');
                        observer.unobserve(entry.target); // Stop watching this msg
                    }, 2500);
                }
            });
        }, { threshold: 0.5 }); // Trigger when 50% of message is visible

        // Force Theme Apply
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            document.documentElement.style.setProperty('--tg-theme-bg-color', Telegram.WebApp.backgroundColor);
            document.documentElement.style.setProperty('--tg-theme-text-color', Telegram.WebApp.textColor);
            document.documentElement.style.setProperty('--tg-theme-hint-color', Telegram.WebApp.hintColor);
            document.documentElement.style.setProperty('--tg-theme-button-color', Telegram.WebApp.buttonColor);
        }

        // ðŸš€ FAST RENDERER FUNCTION
        function appendMessage(msg, isRealtime = false) {
            const container = document.getElementById('logs');
            const isMe = (msg.sender_id == MY_ID);
            
            let displayName = isMe ? 'ME' : (nameMap[msg.sender_id] || 'PARTNER');
            
            let time = "--:--";
            try { 
                const d = new Date(msg.created_at);
                        const dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit' });
                        const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                        time = `${dateStr} ${timeStr}`;
            } catch(e) {}
            
            let content = (msg.message_content || '').replace(/&/g, "&amp;").replace(/</g, "&lt;");
            
            if (msg.photo_file_id) {
                const link = `https://t.me/${BOT_HANDLE}?start=log_${msg.log_id || '0'}`;
                content += `<br><a href="${link}" onclick="Telegram.WebApp.openTelegramLink(this.href); return false;" class="btn-ev">ðŸ“· REQUEST EVIDENCE #${msg.log_id || '?'}</a>`;
            }
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'them'}`;
            div.innerHTML = `
                <div class="meta"><span>${displayName}</span><span>${time}</span></div>
                <div class="content">${content}</div>`;

            // FIX: This now works because 'isRealtime' is defined in the arguments
            if (isRealtime) {
                div.classList.add('unread'); 
                observer.observe(div);       
            }
            
            container.appendChild(div);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function init() {
            if (!TOKEN) return die("NO ACCESS TOKEN");

            const MY_ID = params.get('user_id');
            // 1. GET RIDE (Uses new text-based RPC)
            const { data: rideData, error: rideError } = await db.rpc('get_ride_by_token', { token_input: TOKEN }); 
            const ride = rideData ? rideData[0] : null;

            if (rideError || !ride) return die("INVALID SESSION");
            
            document.getElementById('ride-disp').innerText = ride.ride_id;
            const RIDE_ID = ride.ride_id;

            const statusBadge = document.getElementById('status-badge');
            
            if (USER_HASH) {
                setupAutoClose(USER_HASH, RIDE_ID);
                statusBadge.className = 'badge-live';
                statusBadge.innerText = 'ðŸ”´ LIVE CONNECTION';
                if (window.Telegram && window.Telegram.WebApp) Telegram.WebApp.setHeaderColor('#1a4d1a');
            } else {
                statusBadge.className = 'badge-archive';
                statusBadge.innerText = 'ðŸ“‚ ARCHIVED';
                if (window.Telegram && window.Telegram.WebApp) Telegram.WebApp.setHeaderColor('#000000');
            }


            // 2. FETCH NAMES
            try {
                const { data: names } = await db.from('public_names')
                    .select('user_id, full_name').in('user_id', [ride.driver_id, ride.passenger_id]);
                if (names) names.forEach(n => nameMap[n.user_id] = n.full_name.split(' ')[0].toUpperCase()); 
            } catch (e) {}

            // 3. LOAD HISTORY (Fast)
            const { data: logs } = await db.from('chat_logs')
                .select('*').eq('ride_id', RIDE_ID).order('created_at', { ascending: true });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('terminal').style.display = 'block';

            // ðŸš€ NO TIMEOUTS = FAST LOAD
            if (logs) logs.forEach(msg => appendMessage(msg));

            // 4. REALTIME LISTENER
            db.channel('console_live')
              .on(
                'postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'chat_logs', filter: `ride_id=eq.${RIDE_ID}` },
                (payload) => { appendMessage(payload.new, true); }
              )
              .subscribe();
        }
        // ðŸ”Œ AUTO-CLOSE FUNCTION (Updated for Switching)
        function setupAutoClose(user_hash, currentRideId) {
            if (!user_hash) return;

            console.log(`ðŸ”Œ Guarding Ride ${currentRideId} for User ${user_hash}`);

            // A. Realtime Listener
            db.channel('auto-close-listener')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'public_signals',
                    filter: `user_hash=eq.${user_hash}`
                },
                (payload) => {
                    const newData = payload.new;
                    if (!newData) return;

                    // CRITICAL CHECK:
                    // 1. If chat is not active -> Close
                    // 2. If chat IS active, but the Ride ID changed -> Close
                    if (newData.is_active === false || newData.active_ride_id != currentRideId) {
                        console.log(`â›” Signal: Mismatch or Inactive. (Signals: ${newData.active_ride_id} vs Current: ${currentRideId})`);
                        forceCloseApp();
                    }
                }
            )
            .subscribe();

            // B. Visibility "Wake Up" Check
            document.addEventListener("visibilitychange", async () => {
                if (document.visibilityState === "visible") {
                    console.log("ðŸ‘€ App woke up. Verifying context...");
                    
                    // Fetch both Active Status AND Ride ID
                    const { data } = await db
                        .from('public_signals')
                        .select('is_active, active_ride_id')
                        .eq('user_hash', user_hash)
                        .single();
                    
                    // Same logic as above
                    if (data) {
                        if (data.is_active === false || data.active_ride_id != currentRideId) {
                            console.log("â›” Database mismatch. Closing.");
                            forceCloseApp();
                        }
                    }
                }
            });
        }
    
        // Helper to actually close the app
        function forceCloseApp() {
            console.log("â›” Chat ended. Closing...");
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                document.body.innerHTML = "<h2 style='color:red; text-align:center; margin-top:50px'>â›” CHAT DISCONNECTED</h2>";
            }
        }

        function die(reason) {
            document.getElementById('loader').innerHTML = `<span style="color:red">> ERROR: ${reason}</span>`;
        }

        init();
    </script>
</body>
</html>
