<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SECURE ARCHIVE</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ðŸŽ¨ THEME MAPPING: TERMINAL STYLE ADAPTED TO TELEGRAM */
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --hint: var(--tg-theme-hint-color, #888888);
            --link: var(--tg-theme-link-color, #2481cc);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', Courier, monospace; /* Keeps the console vibe */
            padding: 12px;
            margin: 0;
            padding-bottom: 60px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        #loader {
            position: fixed; top: 40%; left: 0; width: 100%; text-align: center;
            color: var(--hint); font-weight: bold;
        }

        /* HEADER */
        .terminal-header {
            border-bottom: 1px dashed var(--hint);
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: var(--hint);
        }

        /* MESSAGES (Clean, minimal, no bubbles) */
        .msg {
            margin-bottom: 12px;
            opacity: 0; animation: fadeIn 0.2s forwards;
            display: flex; flex-direction: column;
        }
        
        .meta {
            font-size: 10px;
            margin-bottom: 2px;
            color: var(--hint);
            display: flex;
            justify-content: space-between;
        }
        
        .content {
            padding-left: 10px;
            border-left: 3px solid transparent;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* ROLE STYLING */
        /* Me: Colored Border + Bold */
        .me .content {
            border-left-color: var(--btn);
            font-weight: 600; 
        }
        
        /* Them: Grey Border */
        .them .content {
            border-left-color: var(--hint);
        }

        /* EVIDENCE BUTTON */
        .btn-ev {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--btn-text);
            background: var(--btn);
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader">> CONNECTING...</div>
    
    <div id="terminal" style="display:none;">
        <div class="terminal-header">
            > CONNECTION_ESTABLISHED<br>
            > RIDE_ID: <span id="ride-disp">...</span>
        </div>
        <div id="logs"></div>
    </div>

    <script>
        // ðŸŸ¢ INIT TELEGRAM & THEME
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            // This forces the browser to paint using the native colors immediately
            document.documentElement.style.setProperty('--tg-theme-bg-color', Telegram.WebApp.backgroundColor);
            document.documentElement.style.setProperty('--tg-theme-text-color', Telegram.WebApp.textColor);
            document.documentElement.style.setProperty('--tg-theme-hint-color', Telegram.WebApp.hintColor);
            document.documentElement.style.setProperty('--tg-theme-button-color', Telegram.WebApp.buttonColor);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', Telegram.WebApp.buttonTextColor);
        }

        // ðŸ›‘ CONFIG
        const API_URL = 'https://zvoywylatpccjpwvrrhz.supabase.co'; 
        const API_KEY = 'YOUR_SUPABASE_ANON_KEY'; // âš ï¸ PASTE YOUR KEY HERE
        const BOT_HANDLE = 'chengtechtest_bot'; 

        const db = supabase.createClient(API_URL, API_KEY);
        const params = new URLSearchParams(window.location.search);
        const TOKEN = params.get('token');
        const MY_ID = params.get('user_id');

        let nameMap = {};

        function forceEvidenceRequest(fileId) {
            const url = `https://t.me/${BOT_HANDLE}?start=img_${fileId}`;
            Telegram.WebApp.openLink(url, {try_instant_view: false});
            Telegram.WebApp.close();
        }

        async function init() {
            if (!TOKEN) return die("ACCESS_DENIED");

            // 1. GET RIDE
            const { data: rideData, error: rideError } = await db.rpc('get_ride_by_token', { token_input: TOKEN }); 
            const ride = rideData ? rideData[0] : null;

            if (rideError || !ride) return die("INVALID_TOKEN");
            
            document.getElementById('ride-disp').innerText = ride.ride_id;
            const RIDE_ID = ride.ride_id;

            // 2. FETCH NAMES
            try {
                const { data: names } = await db.from('public_names')
                    .select('user_id, full_name').in('user_id', [ride.driver_id, ride.passenger_id]);
                if (names) names.forEach(n => nameMap[n.user_id] = n.full_name.split(' ')[0].toUpperCase()); 
            } catch (e) {}

            // 3. FETCH EXISTING HISTORY
            const { data: logs } = await db.from('chat_logs')
                .select('*').eq('ride_id', RIDE_ID).order('created_at', { ascending: true });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('terminal').style.display = 'block';

            if (logs) logs.forEach((msg, i) => setTimeout(() => appendMessage(msg), i * 20));

            // âš¡ 4. DUAL REALTIME LISTENER âš¡
            db.channel('chat_console')
              // A. WATCH FOR NEW MESSAGES (Live Update)
              .on(
                'postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'chat_logs', filter: `ride_id=eq.${RIDE_ID}` },
                (payload) => {
                    console.log("> INCOMING:", payload.new);
                    appendMessage(payload.new);
                }
              )
              // B. WATCH FOR EXIT COMMAND (Kill Switch)
              .on(
                'postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'users', filter: `user_id=eq.${MY_ID}` },
                (payload) => {
                  if (payload.new.active_chat_id === null) {
                      Telegram.WebApp.close();
                  }
                }
              )
              .subscribe();
        }

        function appendMessage(msg) {
            const container = document.getElementById('logs');
            const isMe = (msg.sender_id == MY_ID);
            
            let displayName = isMe ? 'ME' : (nameMap[msg.sender_id] || 'PARTNER');
            
            let time = "--:--";
            try { 
                const d = new Date(msg.created_at);
                const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                time = timeStr;
            } catch(e) {}
            
            let content = (msg.message_content || '').replace(/&/g, "&amp;").replace(/</g, "&lt;");
            
            if (msg.photo_file_id) {
                content += `<br><div onclick="forceEvidenceRequest('${msg.photo_file_id}')" class="btn-ev">ðŸ“· VIEW EVIDENCE</div>`;
            }
            
            const html = `
                <div class="msg ${isMe ? 'me' : 'them'}">
                    <div class="meta"><span>${displayName}</span><span>${time}</span></div>
                    <div class="content">${content}</div>
                </div>`;
            
            container.insertAdjacentHTML('beforeend', html);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function die(reason) {
            document.getElementById('loader').innerHTML = `<span style="color:var(--text)">> FATAL ERROR: ${reason}</span>`;
        }

        init();
    </script>
</body>
</html>
